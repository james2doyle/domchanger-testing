<!DOCTYPE html>
<html>
<head>
  <title>DomChanger Example</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
  <style type="text/css" media="screen">
    button {
      margin-left: 1em;
    }
    li {
      position: relative;
    }
    label {
      opacity: 1;
      transition: opacity 0.4s ease;
    }
    label:hover {
      cursor: pointer;
    }
    .completed label {
      opacity: 0.4;
      text-decoration: line-through;
    }
    span {
      position: absolute;
      top: 0;
      left: 350px;
      font-family: arial;
      font-weight: bold;
      opacity: 0;
      transition: all 0.4s ease;
    }
    .completed span {
      left: 150px;
      opacity: 1;
    }
    span:hover {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="application"></div>
  <script src="fetch.js"></script>
  <script src="domchanger.js"></script>
  <script>
    function TodoApp(emit, refresh) {
      var items = [], text = "";
      function render() {
        return ["div",
        ["h3", "TODO"],
        [TodoList, items],
        ["form", {
          onsubmit: handleSubmit
        },
        ["input", {
          onchange: onChange,
          autofocus: true,
          value: text,
          type: 'text'
        }],
        ["button", {
          type: 'submit'
        }, "Add #", items.length + 1],
        ["button", {
          type: 'button',
          onclick: handleFetch
        }, "Fetch"]
        ]
        ];
      }

      function handleSubmit(event) {
        event.preventDefault();
        // dont submit empty
        if (text.trim()) {
          items.push(text);
          text = "";
          refresh();
        }
      }

      function handleFetch() {
        fetch('items.json')
        .then(function(res) {
          return res.json();
        }).then(function(json) {
          json.forEach(function(text) {
            items.push(text.text);
          });
          refresh();
        }).catch(function(ex) {
          console.log('parsing failed', ex);
        })
      }

      function onChange(event) {
        text = event.target.value;
      }

      return { render: render };
    }

    function TodoList() {
      function render(items) {
        function toggleState(event) {
          this.parentElement.parentElement.classList.toggle('completed');
        }
        function deleteItem(index) {
          if (items.length <= 1) {
            items = [];
          } else {
            items.splice(index, 1);
          }
          app.update();
        }
        return ["ul", items.map(function (itemText, index) {
          return ["li", {
            id: 'item-' + index
          },
          ["label", { for: 'input-' + index },
          ["input", {
            id: 'input-' + index,
            onclick: toggleState,
            value: 1,
            type: 'checkbox'
          }],
          itemText
          ],
          ["span", {
            id: 'delete-' + index,
            onclick: deleteItem.bind(this, index),
            value: 1,
            class: 'delete'
          }, 'X']
          ];
        })];
      }
      return { render: render };
    }
    window.app = domChanger(TodoApp, document.getElementById('application'));
    app.update();
  </script>
</body>
</html>